<html><!-- InstanceBegin template="/Templates/index.dwt" codeOutsideHTMLIsLocked="false" -->

<head>
<!-- InstanceBeginEditable name="doctitle" -->
<title></title>
<!-- InstanceEndEditable -->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link href="css/styles.css" rel="stylesheet" type="text/css">



<link href="css/styles.css" rel="stylesheet" type="text/css">
<!-- InstanceBeginEditable name="head" -->
<style type="text/css">
<!--
.стиль4 {color: #FF0000}
.стиль11 {color: #0000CC}
-->
</style>
<!-- InstanceEndEditable -->
<style type="text/css">
<!--
.стиль5 {color: #FFFFFF; font-weight: bold; font-family: Verdana, Arial, Helvetica, sans-serif;}
.стиль10 {font-size: 12px; }
.стиль12 {color: #FFFFFF; font-weight: bold; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; }
.стиль22 {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: x-small;
	color: #FFCC00;
	font-weight: bold;
}
-->
</style>
</head>

<body class="body">

<table border="0" cellpadding="0" cellspacing="0" width="100%">
  <tr>
    <td width="100%" align="left" valign="top">
    	<table width="100%" border="0" cellpadding="0" cellspacing="0">
      	<tr>
        	<td align="left" valign="top" class="logobg"><img src="images/logo.jpg" alt="Логотип сайта" width="350" height="100"></td>
        </tr>
    	</table>
    	<table width="100%" border="0" cellpadding="0" cellspacing="0">
      	<tr>
					<td width="10" bgcolor="#FFCC00">&nbsp;</td>
       	  <td align="center" valign="top" bgcolor="#336633">
					<br>
						<table width="150" height="148" border="0" cellpadding="0" cellspacing="1" class="ref">
    					<tr> 
      					<td height="20" align="center" class="стиль5"><h3 class="стиль10"><a href="index.html" title="Главная страница сайта" class="стиль5">Головна</a></h3></td>
	   					</tr>
    					<tr>
                          <td height="20" align="center" class="стиль5"><h3 class="стиль10"><a href="spiski.html" class="стиль5">Списки</a></h3></td>
  					  </tr>
    					<tr>
                          <td height="20" align="center" class="стиль5"><h3 class="стиль10"><a href="tabread.html" class="стиль5">Перегляд номерів</a></h3></td>
  					  </tr>
    					<tr>
                          <td height="20" align="center" class="стиль5"><h3 class="стиль10"><a href="tabwrite.html" class="стиль5">Додавання номерів </a></h3></td>
  					  </tr>
    					<tr>
    					  <td height="20" align="center" class="стиль5"><h3 class="стиль10"><a href="calendar.html" class="стиль5">Календар</a></h3></td>
  					  </tr>
    					<tr>
    					  <td height="20" align="center" class="стиль5"><h3 class="стиль10"><a href="povidom.html" class="стиль5">Повідомлення</a></h3></td>
  					  </tr>
    					<tr>
   					  <td height="20" align="center" class="стиль5"><h3 class="стиль10"><a href="listcsv.html" class="стиль5">Звіти</a></h3></td>
  					  </tr>
			  </table>
			<p>&nbsp;</p>
			<p><span class="стиль12"><a href="setting.html" class="стиль12">Налаштування</a></span>            
			<p><span class="стиль12"><br>
			  </span>            <span class="стиль22"><a href="help.html" class="стиль22">Допомога</a></span><span class="стиль12"><br>
		      </span><br>
			  <br>
			  <br>		  
          </td>
					<td width="10" align="left" valign="top" bgcolor="#FFCC00">&nbsp;</td>
    			<td width="2" bgcolor="#336633"><img src="images/xnew.gif" alt="Заработок на платных опросах" width="2" height="500"></td>
        	<td width="100%" align="left" valign="top" bgcolor="#FFFFFF">
        		<table border="0" cellpadding="0" cellspacing="0" width="100%">
          		<tr>
            		<td width="100%"><img src="images/n.gif" alt="Здоровье детей" width="10" height="10"></td>
            	</tr>
        		</table>
        		<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse" width="100%">
          		<tr>
            		<td width="10" align="left" valign="top"><img src="images/n.gif" alt="Новый сайт" width="10" height="10"></td>
            		<td width="100%" align="left" valign="top">
									<table class="refhome" width="100%" bgcolor="#336633" border="0" cellspacing="1" cellpadding="0">
        						<tr>
          						<td bgcolor="#FFFFFF" align="center" nowrap><a href="index.html" title="Главная страница сайта" class="ref"><b>Головна</b></a></td>
          						<td align="center" nowrap bgcolor="#FFFFFF"><a href="spiski.html" title="Главная страница сайта" class="ref"><b>Списки</b></a></td>
          						<td align="center" nowrap bgcolor="#FFFFFF"><a href="tabread.html" class="ref"><b>Перегляд номерів </b></a></td>
          						<td align="center" nowrap bgcolor="#FFFFFF"><a href="tabwrite.html" class="ref"><b> Додавання номерів </b></a></td>
        						<td align="center" nowrap bgcolor="#FFFFFF"><a href="calendar.html" class="ref"><b> Календар </b></a></td>
        						<td align="center" nowrap bgcolor="#FFFFFF"><a href="povidom.html" class="ref"><strong>Повідомлення</strong></a></td>
        						</tr>
      						</table>	
									<br>
									<table width="100%">
                    <tr>
                      <td align="right">
											<div align="justify" class="text">
											  <!-- InstanceBeginEditable name="EditRegion3" -->
											  <a name="nachalo"></a>
											  <FORM ENCTYPE="multipart/form-data" ACTION="" METHOD=POST>
											    <table width="100%" border="3" bordercolor="#FFCC00">
    <tr>
      <td bordercolor="#FFCC00"><strong>
      1. В<span lang="uk">и</span>беріть список:
      <select name="Spisok">
        <?php
$connection = pg_connect ("dbname=asterisk user='asterisk' password='12345' ");
$vrem = 43200 + time();
$spis = $_POST['Spisok'];

$result2=pg_query($connection, "select * from spiski order by spisok");
while($db2=pg_fetch_array($result2)):
 $spi=$db2['spisok'];
 $nspi=$db2['namespis'] ;
//if (isset($_POST['Spisok'])
if($spis == $spi) 
{
 echo "<option value='$spi' selected='selected'>$nspi</option>";
} 
else 
{
 echo "<option value='$spi'>$nspi</option>";
};
endwhile;
?>
      </select>
      </strong></td>
    </tr>
    <tr>
      <td bordercolor="#FFCC00"><strong><span lang="uk">2. Видалити старі записи вибраного списку з бази</span>
          <input type="Checkbox" value="Удалить" checked="checked" name="udal" style="width: 20px">
      </strong></td>
    </tr>
    <tr>
      <td bordercolor="#FFCC00"><strong>3. Повне видалення усіх списків з бази
          <input name="vydal" type="checkbox" id="vydal" value="checkbox">
      </strong></td>
    </tr>
    <tr>
      <td bordercolor="#FFCC00"><strong>
        4. Виберіть файл:
            <input name="myfile" type="file">
        <input name="submit" type="submit" style="height: 25px" value="ЗАВАНТАЖИТИ">
        ;; -
         <input name="rozd" type="checkbox" id="rozd" value="checkbox">
      </strong></td>
    </tr>
  </table>
                                                <p><strong>*Виберіть список та файл з номерами, який повинен бути завантажений в список. Перевірте необхідні опції та натисніть ЗАВАНТАЖИТИ.</strong> </p>
                                                <p><strong class="стиль11">Формат файлу повинен бути:</strong> <br/>
                                                  <span class="стиль11">номер телефону, сума боргу, будь-яке число (число можна опустити)<br/>
                                                наступний номер, сума, будь-яке число (число можна опустити)<br/>
                                                XXXXXX,CCC,NNNN(через кому) </span></p>
  </FORM>

                                              <p><a href="#konec">перехід в кінець</a>                                             </p>
                                                 
                                              <?php

if(isset($_FILES["myfile"])) 
{ 
if ( !(file_exists("/tmp/vrem.tmp")))
{
set_time_limit(0);
ignore_user_abort(1); // run script in background 

        $myfile = $_FILES["myfile"]["tmp_name"]; 
//        $myfile_name = $_FILES["myfile"]["name"]; 
//        $myfile_size = $_FILES["myfile"]["size"]; 
//        $myfile_type = $_FILES["myfile"]["type"]; 
        $error_flag = $_FILES["myfile"]["error"]; 
     copy ($myfile, "/tmp/vrem.tmp") ; 
$err = 0;
  $udal=isset($_POST["udal"]); 
	if(isset($_POST['rozd'])) $rozd = ";"; else $rozd = ",";
        		
            // Получаем содержимое файла 
    if(!($fp = fopen("/tmp/vrem.tmp","r")))
    	echo "Не могу открыть временный файл!!!";//<META HTTP-EQUIV=\"Refresh\" content =\"2; URL='tabwrite.html'\">" ;

 if ($udal == 1) 
 	{		
				if(!($fp000 = fopen("/tmp/vrem000.tmp","w"))) echo "Не могу открыть временный файл!!!";//<META HTTP-EQUIV=\"Refresh\" content =\"2; URL='tabwrite.html'\">" ;
				if(isset($_POST['vydal'])) $result000=pg_query($connection, 'select nomer, summa, vrem, kol, otv, norm, aon, spisok from obzvon ;');
				else $result000=pg_query($connection, 'select nomer, summa, vrem, kol, otv, norm, aon, spisok from obzvon where spisok =  ' . $spis . ';');
				fputcsv($fp000, Array(iconv("UTF-8","windows-1251","Номер"),iconv("UTF-8","windows-1251","Сума"),iconv("UTF-8","windows-1251","Час останнього дзв."), iconv("UTF-8","windows-1251","Кількість спроб"), iconv("UTF-8","windows-1251","Відповідь"), iconv("UTF-8","windows-1251","Стан"), iconv("UTF-8","windows-1251","АВН"), iconv("UTF-8","windows-1251","Список")), ";");
				while($row000 = pg_fetch_assoc($result000))
					{
						fputcsv($fp000, $row000, ";");
					};
				fclose($fp000);	
				$vremen = rtrim(`sudo -i date +%Y%m%d-%R`);
				copy ( "/tmp/vrem000.tmp", "/var/www/html/Files/$vremen.csv" ) ; 
				unlink("/tmp/vrem000.tmp");
	}	
	$kilk_zap = 0;	
	while (($data = fgetcsv($fp, 32, $rozd)) !== FALSE) 
	{
	    $num = count($data);
        
    	$row++;
        if (($num == 3)||($num == 2))
        {    
    	    if (($row == 1)&&($udal == 1)) 
    	    {	  
	
				if(isset($_POST['vydal']))
				{
					if (pg_query($connection, "TRUNCATE TABLE obzvon;") !== FALSE)
					{
						echo "<span class=\"стиль4\">Всі записи в базі видалені! </span><br/>";
						pg_query($connection, "ALTER SEQUENCE nom_seq  RESTART WITH 1;");		
//						pg_query($connection, "ALTER SEQUENCE spisok_seq  RESTART WITH 1;");
					}
				} else
        		if (pg_query($connection, "DELETE FROM obzvon where spisok = $spis;") !== FALSE)
        		{
				
        	    	echo "<span class=\"стиль4\">Всі записи списку $spis з бази видалені! </span><br/>";
					$fl = 1;
        		}
                                                            
    	    };
//	    	if (pg_query($connection, "INSERT INTO obzvon( nomer, summa, spisok) VALUES ($data[0], ceil($data[1]), $spis);") !== FALSE)
			if (pg_query($connection, "INSERT INTO vremen( vrem_nomer, vrem_summa, spisok) VALUES ($data[0], ceil($data[1]));") !== FALSE)
	    	{
				$kilk_zap++;//echo "Запис списку $spis про номер $data[0], на якому сума боргу $data[2] грн. занесено в базу. <br/>";
					
	    	} else 
			{
				echo "<span class=\"стиль4\">Запис про номер $data[0], неможливо занести в базу. </span><br/>";
				$err++;
			}
		} 
		else if (!($num == 1 && $data[0] == ""))
		{
			echo "<h3><span class=\"стиль4\">ЗАПИС ПОВИНЕН МАТИ ФОРМУ: телефон, сума_боргу, число<br />";
			echo "КОЖЕН ЗАПИС НА ОКРЕМІЙ СТРОЦІ ТІЛЬКИ ЦИФРИ ТА КОМА,<br />";
			echo "БЕЗ СТОРОННІХ СИМВОЛІВ!!! ПЕРЕВІРТЕ ФАЙЛ!!!.</span></h3>";
			$err = 99999999;
			break;
		}        
     }
fclose($fp);	 

`sudo -i asterisk -rx \"dialplan set global Kan1 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan2 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan3 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan4 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan5 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan6 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan7 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan8 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan9 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan10 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan11 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan12 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan13 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan14 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan15 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan17 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan18 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan19 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan20 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan21 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan22 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan23 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan24 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan25 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan26 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan27 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan28 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan29 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan30 0\"`;
`sudo -i asterisk -rx \"dialplan set global Kan31 0\"`;


//$result=pg_query($connection, 'select vrem_nomer, vrem_summa from vremen order by vrem_summa desc');

// while ($db=pg_fetch_array($result)):

//if (pg_query($connection, "INSERT INTO obzvon( nomer, summa, spisok) VALUES ($db[0], $db[1], $spis);") == FALSE)
if (pg_query($connection, "INSERT INTO obzvon (nomer, summa, spisok) select vrem_nomer, vrem_summa, $spis  from vremen order by vrem_summa desc;") == FALSE)
echo "<span class=\"стиль4\">Помилка копіювання бази. </span><br/>";
//endwhile;

if ($spis > 0) 
{
	if (pg_query($connection, "UPDATE spiski SET vrem = $vrem WHERE spisok = $spis;") == FALSE)
echo "<span class=\"стиль4\">Помилка зміни часу в списку $spis. </span><br/>";
}

if ($err == 0) echo "<h3><span class=\"стиль11\">Імпорт файла завершено. Добавлено $kilk_zap записів.</span></h3>" ; else if ($err != 99999999) echo "<h3><span class=\"стиль4\">Імпорт файла завершено, але в файлі були помилки, тому було виключено $err записів (Див. вище)! Добавлено $kilk_zap записів.</span></h3>";
if (pg_query($connection, "TRUNCATE TABLE vremen;") !== FALSE)
					{
					
						pg_query($connection, "ALTER SEQUENCE vremen_seq  RESTART WITH 1;");		
//					
					}
					else echo "<span class=\"стиль4\">Не можу очистити тимчасову таблицю. </span><br/>";
}
else echo "<span class=\"стиль4\">Не завершено попереднє завантаження файлу. Повторіть завантаження через декілька хвилин.</span>";
}
$ostann = pg_fetch_array(pg_query($connection, "select nom_id from obzvon ORDER BY nom_id DESC LIMIT 1;"));

echo "<br/>Після останнього повного видалення усіх записів з бази добавлено " . $ostann['nom_id'] . " записів";
unlink("/tmp/vrem.tmp") ; 
pg_close($connection);
?>
                                              <p class="стиль4"><a name="konec" id="konec"></a><span class="стиль11"><a href="#nachalo">перехід на початок </a></span></p>
                                              <h3 class="стиль4">&nbsp;</h3>
											  <!-- InstanceEndEditable -->
											  <p>&nbsp;</p>
											  <p>&nbsp;</p>
						</div>					  </td>
                    </tr>
                    <tr>
                      <td align="center"><table class="refhome" width="100%" bgcolor="#336633" border="0" cellspacing="1" cellpadding="0">
                        <tr>
                          <td bgcolor="#FFFFFF" align="center" nowrap><a href="index.html" title="Главная страница сайта" class="ref"><b>Головна</b></a></td>
                          <td align="center" nowrap bgcolor="#FFFFFF"><a href="spiski.html" title="Главная страница сайта" class="ref"><b>Списки</b></a></td>
                          <td align="center" nowrap bgcolor="#FFFFFF"><a href="tabread.html" class="ref"><b>Перегляд номерів </b></a></td>
                          <td align="center" nowrap bgcolor="#FFFFFF"><a href="tabwrite.html" class="ref"><b> Додавання номерів </b></a></td>
                          <td align="center" nowrap bgcolor="#FFFFFF"><a href="calendar.html" class="ref"><b> Календар </b></a></td>
                          <td align="center" nowrap bgcolor="#FFFFFF"><a href="povidom.html" class="ref"><strong>Повідомлення</strong></a></td>
                        </tr>
                      </table></td>
                    </tr>
                  </table>
				  <br>				  </td>
            		<td width="10" align="left" valign="top">
            <img src="images/n.gif" alt="Новый сайт" width="10" height="10">				  </td>
          		</tr>
        		</table>		  </td>
      	</tr>
    	</table>
    	<table border="0" cellpadding="0" cellspacing="0" width="100%">
      	<tr>
        	<td width="100%">
        <img src="images/fonbt.jpg" alt="Здоровье детей" width="100%" height="13" border="0">		  </td>
      	</tr>
    	</table>
    	<table border="0" cellpadding="0" cellspacing="0" width="100%">
      	<tr>
        	<td width="100%">&nbsp;</td>
        	<td width="100%" align="center" nowrap class="text"><a href="mailto:olazebnyk@ukrtelecom.ua">olazebnyk@ukrtelecom.ua</a></td>
      	</tr>
    	</table>	</td>
  </tr>
</table>
</body>
<!-- InstanceEnd --></html>